[workspace]
name = "mojo-puzzles"
channels = ["https://conda.modular.com/max-nightly/", "conda-forge"]
platforms = ["linux-64"]

[feature.nvidia]
system-requirements = { cuda = "12" }
channels = ["nvidia"]

[feature.nvidia.target.linux-64.dependencies]
cuda-toolkit = "12.*" # for compute-sanitizer etc.
cuda-gdb = "12.*"     # for GPU kernel debugging
nsight-compute = "*"  # interactive kernel profiling

[feature.nvidia.target.linux-64.pypi-dependencies]
torch = { version = "==2.7.1", index = "https://download.pytorch.org/whl/cu128" }
nvidia-ml-py = "*"

[feature.amd]
system-requirements = {}

[feature.amd.target.linux-64.pypi-dependencies]
torch = { version = "==2.7.1", index = "https://download.pytorch.org/whl/rocm6.3" }
pytorch-triton-rocm = {version = "*", index = "https://download.pytorch.org/whl/rocm6.3" }

[feature.apple]
system-requirements = { macos = "15.0" }

[dependencies]
python = "==3.12"
mojo = "<1.0.0" # includes `mojo-compiler`, lsp, debugger, formatter etc.
max = "==26.2.0.dev2026020505"
bash = ">=5.2.21,<6"
manim = ">=0.18.1,<0.19"
mdbook = ">=0.4.48,<0.5"
pre-commit = ">=4.2.0,<5"

[environments]
nvidia = { features = ["nvidia"], solve-group = "nvidia" }
amd = { features = ["amd"], solve-group = "amd" }
apple = { features = ["apple"], solve-group = "apple" }
default = { features = ["nvidia"] }

[tasks]
install-pre-commit = "pre-commit install"
format = { cmd="mojo format problems solutions", depends-on = ["install-pre-commit"] }
format-check = { cmd = "bash -c 'mojo format problems solutions && git diff --exit-code problems solutions || (echo \"Error: Code is not formatted. Run \\\"pixi run format\\\" to fix.\" && exit 1)'", description = "Check if code is formatted without modifying files" }

tests = { cmd = "bash solutions/run.sh" }

# Setup CUDA-GDB by linking system CUDA installation to conda environment
setup-cuda-gdb = { cmd = "bash scripts/setup-cuda-gdb.sh", description = "Auto-detect and link system CUDA-GDB binaries to conda environment" }

zero-memory-manager = { cmd = "export MODULAR_DEVICE_CONTEXT_MEMORY_MANAGER_SIZE_PERCENT=0" }
memcheck = { cmd = "bash solutions/sanitizer.sh memcheck", depends-on = ["zero-memory-manager"] }
racecheck = { cmd = "bash solutions/sanitizer.sh racecheck", depends-on = ["zero-memory-manager"] }
synccheck = { cmd = "bash solutions/sanitizer.sh synccheck", depends-on = ["zero-memory-manager"] }
initcheck = { cmd = "bash solutions/sanitizer.sh initcheck", depends-on = ["zero-memory-manager"] }
sanitizers = { cmd = "bash solutions/sanitizer.sh all", depends-on = ["zero-memory-manager"] }

p01 = "mojo problems/p01/p01.mojo"
p02 = "mojo problems/p02/p02.mojo"
p03 = "mojo problems/p03/p03.mojo"
p04 = "mojo problems/p04/p04.mojo"
p04_layout_tensor = "mojo problems/p04/p04_layout_tensor.mojo"
p05 = "mojo problems/p05/p05.mojo"
p05_layout_tensor = "mojo problems/p05/p05_layout_tensor.mojo"
p06 = "mojo problems/p06/p06.mojo"
p07 = "mojo problems/p07/p07.mojo"
p07_layout_tensor = "mojo problems/p07/p07_layout_tensor.mojo"
p08 = "mojo problems/p08/p08.mojo"
p08_layout_tensor = "mojo problems/p08/p08_layout_tensor.mojo"
p09 = "mojo problems/p09/p09.mojo"
p10 = "mojo problems/p10/p10.mojo"
p11 = "mojo problems/p11/p11.mojo"
p11_layout_tensor = "mojo problems/p11/p11_layout_tensor.mojo"
p12 = "mojo problems/p12/p12.mojo"
p12_layout_tensor = "mojo problems/p12/p12_layout_tensor.mojo"
p13 = "mojo problems/p13/p13.mojo"
p14 = "mojo problems/p14/p14.mojo"
p15 = "mojo problems/p15/p15.mojo"
p16 = "mojo problems/p16/p16.mojo"
p17 = "mojo package problems/p17/op -o problems/p17/op.mojopkg && python problems/p17/p17.py"
p18-package = "mojo package problems/p18/op -o problems/p18/op.mojopkg"
p18-test-kernels = { cmd = "mojo run -I problems/p18 problems/p18/test/test_softmax.mojo", depends-on = ["p18-package"] }
p18 = { cmd = "python problems/p18/p18.py", depends-on = ["p18-package"] }
p19 = "mojo package problems/p19/op -o problems/p19/op.mojopkg && python problems/p19/p19.py"
p20 = "python problems/p20/p20.py"
p21 = "python problems/p21/p21.py"
p22 = "python problems/p22/p22.py"
p23 = "mojo problems/p23/p23.mojo"
p24 = "mojo problems/p24/p24.mojo"
p25 = "mojo problems/p25/p25.mojo"
p26 = "mojo problems/p26/p26.mojo"
p27 = "mojo problems/p27/p27.mojo"
p28 = "mojo problems/p28/p28.mojo"
p29 = "mojo problems/p29/p29.mojo"
p30 = "mojo problems/p30/p30.mojo"
p31 = "mojo problems/p31/p31.mojo"
p32 = "mojo problems/p32/p32.mojo"
p33 = "mojo problems/p33/p33.mojo"
p34 = "mojo problems/p34/p34.mojo"

# GPU information and profiling utilities
gpu-info = { cmd = "python3 scripts/gpu_specs.py --summary", description = "Get concise GPU information (cross-platform)" }
gpu-specs = { cmd = "python3 scripts/gpu_specs.py", description = "Get complete GPU architectural specifications (NVIDIA/AMD/Apple Silicon)" }

# macOS environment validation
check-macos = { cmd = "python3 scripts/check_macos_env.py", description = "Validate macOS environment (version, Xcode, Metal toolchain)" }

generate-animations = { cmd = "echo 'All animations generated!'", depends-on = ["viz01", "viz02", "viz03", "viz04", "viz05", "viz06", "viz07", "viz08", "viz11", "viz12", "viz13", "viz14", "viz15", "viz16", "rooflineviz", "thread_indexing"] }
clean-animations = "find book/src -type d -name media | xargs rm -rf"
clean-profiles = "bash -c 'find . -maxdepth 1 -type f \\( -name \"*.sqlite\" -o -name \"*.txt\" -o -name \"*.nsys-rep\" -o -name \"*.ncu-rep\" \\) -delete && find problems -type f \\( -name \"*.sqlite\" -o -name \"*.txt\" -o -name \"*.nsys-rep\" -o -name \"*.ncu-rep\" \\) -delete'"
clean-all = { cmd = "cleanup is done!", depends-on = ["clean-animations", "clean-profiles"] }

